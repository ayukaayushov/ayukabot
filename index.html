<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –û–±—ä—è–≤–ª–µ–Ω–∏–π</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ */
        body {
            font-family: sans-serif;
            padding: 10px;
            color: var(--tg-theme-text-color); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã Telegram */
            background-color: var(--tg-theme-bg-color);
        }
        #categories-list, #ads-list {
            list-style: none;
            padding: 0;
            margin: 10px 0; /* –î–æ–±–∞–≤–∏–º –æ—Ç—Å—Ç—É–ø—ã */
        }
        #categories-list li, #ads-list li {
            padding: 8px 5px;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 30px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
        }
         #categories-list li:hover {
             background-color: var(--tg-theme-secondary-bg-color);
         }
        .category-name {
            flex-grow: 1;
            margin-right: 10px;
        }
        .nav-arrow { /* –°—Ç—Ä–µ–ª–æ—á–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –¥–µ—Ç—å–º–∏ */
             color: var(--tg-theme-hint-color);
             font-weight: bold;
             margin-left: 5px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –¥–ª—è —Å—Ç—Ä–µ–ª–∫–∏ */
        }
        .ad-preview {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        button {
            padding: 5px 8px;
            margin-left: 5px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
        }
        #back-button {
            margin-bottom: 10px;
            padding: 8px 12px; /* –°–¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –ù–∞–∑–∞–¥ —á—É—Ç—å –±–æ–ª—å—à–µ */
        }
        #loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color);
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
         #error-message {
             text-align: center;
             padding: 20px;
             color: var(--tg-theme-destructive-text-color, red); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –æ—à–∏–±–æ–∫ –∏–∑ —Ç–µ–º—ã –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π */
             font-weight: bold;
             display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
         }
         /* –°—Ç–∏–ª—å –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è "–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π/–æ–±—ä—è–≤–ª–µ–Ω–∏–π" */
         .empty-list-message {
             padding: 15px 5px;
             text-align: center;
             color: var(--tg-theme-hint-color);
             cursor: default;
         }
    </style>
</head>
<body>

    <h2 id="current-path">–ö–∞—Ç–∞–ª–æ–≥</h2>
    <button id="back-button" style="display: none;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error-message"></div>

    <ul id="categories-list">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    </ul>

    <hr style="border: none; border-top: 1px solid var(--tg-theme-hint-color); margin: 10px 0;">

    <ul id="ads-list">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
    </ul>

    <script>
        // –û–±–µ—Ä–Ω–µ–º –≤–µ—Å—å –∫–æ–¥ –≤ try-catch –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        try {
            const tg = window.Telegram.WebApp;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ tg –æ–±—ä–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!tg) {
                console.error("–û–±—ä–µ–∫—Ç Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                document.body.innerHTML = '<div id="error-message" style="display: block;">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Telegram Web App. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram.</div>';
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                throw new Error("Telegram.WebApp not found");
            }

            const apiBaseUrl = "http://127.0.0.1:8000"; // URL –≤–∞—à–µ–≥–æ API (–∏–ª–∏ HTTPS –æ—Ç ngrok)
            console.log(`[INIT] API Base URL: ${apiBaseUrl}`);

            const categoriesListEl = document.getElementById('categories-list');
            const adsListEl = document.getElementById('ads-list');
            const currentPathEl = document.getElementById('current-path');
            const backButton = document.getElementById('back-button');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-message');

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            if (!categoriesListEl || !adsListEl || !currentPathEl || !backButton || !loadingEl || !errorEl) {
                console.error("–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã!");
                throw new Error("Missing required DOM elements");
            }

            let categoryHistory = []; // –°—Ç–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ [{id, name}]

            // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ---

            function showLoading() {
                console.log('[UI] –ü–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑–∫–∏');
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                // –ù–µ –æ—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏ –∑–¥–µ—Å—å, –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º
                // categoriesListEl.innerHTML = '';
                // adsListEl.innerHTML = '';
            }

            function hideLoading() {
                 console.log('[UI] –°–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏');
                loadingEl.style.display = 'none';
            }

            function showError(message) {
                console.log(`[UI] –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏: ${message}`);
                hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                errorEl.textContent = `–û—à–∏–±–∫–∞: ${message}`;
                errorEl.style.display = 'block';
                 // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                 categoriesListEl.innerHTML = '';
                 adsListEl.innerHTML = '';
            }

            function renderCategories(categories) {
                console.log('[Render] –ù–∞—á–∞–ª–æ renderCategories —Å –¥–∞–Ω–Ω—ã–º–∏:', categories);
                try {
                    categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
                    if (!categories || categories.length === 0) {
                         console.log('[Render] –ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                         // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                         if (categoryHistory.length > 0) {
                              const li = document.createElement('li');
                              li.className = 'empty-list-message'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∞—Å—Å
                              li.textContent = '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç';
                              categoriesListEl.appendChild(li);
                         }
                         // –ï—Å–ª–∏ –∏ –≤ –∫–æ—Ä–Ω–µ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç–æ–∂–µ –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                         else {
                              const li = document.createElement('li');
                              li.className = 'empty-list-message';
                              li.textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.';
                              categoriesListEl.appendChild(li);
                         }
                         return; // –í—ã—Ö–æ–¥–∏–º, –µ—Å–ª–∏ –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç
                    }

                    categories.forEach((cat, index) => {
                        console.log(`[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${index}:`, cat);
                        // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        if (typeof cat !== 'object' || cat === null || typeof cat.id === 'undefined' || typeof cat.name === 'undefined') {
                             console.error(`[Render] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∞ –∏–Ω–¥–µ–∫—Å–µ ${index}:`, cat);
                             return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç (continue –¥–ª—è forEach)
                        }

                        const li = document.createElement('li');
                        li.dataset.categoryId = cat.id;

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'category-name';
                        nameSpan.textContent = cat.name; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∫–∞–∫ –µ—Å—Ç—å
                        li.appendChild(nameSpan);

                        // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–¥–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ —Å—Ç—Ä–µ–ª–∫–æ–π –¥–ª—è –ª—É—á—à–µ–≥–æ –≤–∏–¥–∞)
                        const subscribeBtn = document.createElement('button');
                        subscribeBtn.textContent = 'üîî'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫—É
                        subscribeBtn.title = `–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${cat.name}`; // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
                        subscribeBtn.addEventListener('click', (event) => {
                            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–∫ –ø–æ li
                            console.log(`[Action] –ö–ª–∏–∫ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${cat.id}`);
                            subscribeToCategory(cat.id);
                        });
                        li.appendChild(subscribeBtn);

                        // –°—Ç—Ä–µ–ª–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                        if (cat.has_children) {
                            const arrowSpan = document.createElement('span');
                            arrowSpan.className = 'nav-arrow';
                            arrowSpan.textContent = '>';
                            li.appendChild(arrowSpan);
                            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å—é —Å—Ç—Ä–æ–∫—É li (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏)
                            li.addEventListener('click', (event) => {
                                // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –±—ã–ª –ø–æ –∫–Ω–æ–ø–∫–µ –≤–Ω—É—Ç—Ä–∏ li
                                if (event.target === li || event.target === nameSpan || event.target === arrowSpan) {
                                     console.log(`[Action] –ö–ª–∏–∫ –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${cat.id}`);
                                     navigateToCategory(cat.id, cat.name);
                                }
                            });
                        } else {
                            // –ï—Å–ª–∏ –¥–µ—Ç–µ–π –Ω–µ—Ç, –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                             li.addEventListener('click', (event) => {
                                if (event.target === li || event.target === nameSpan) {
                                     console.log(`[Action] –ö–ª–∏–∫ –ü–æ–∫–∞–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${cat.id}`);
                                     showAds(cat.id, cat.name);
                                }
                            });
                        }

                        categoriesListEl.appendChild(li);
                    });
                    console.log('[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.');
                } catch (renderError) {
                     console.error('[Render] –û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–∏ renderCategories:', renderError);
                     showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π. ${renderError.message}`);
                }
            }

            function renderAds(adsResponse) {
                 console.log('[Render] –ù–∞—á–∞–ª–æ renderAds —Å –¥–∞–Ω–Ω—ã–º–∏:', adsResponse);
                 try {
                     adsListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
                     if (!adsResponse || !adsResponse.items || adsResponse.items.length === 0) {
                          console.log('[Render] –ù–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
                         const li = document.createElement('li');
                         li.className = 'empty-list-message';
                         li.textContent = '–û–±—ä—è–≤–ª–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç.';
                         adsListEl.appendChild(li);
                         return;
                     }

                     adsResponse.items.forEach((ad, index) => {
                          console.log(`[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ${index}:`, ad);
                          if (typeof ad !== 'object' || ad === null || typeof ad.id === 'undefined' || typeof ad.text_preview === 'undefined') {
                                console.error(`[Render] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–∞ –∏–Ω–¥–µ–∫—Å–µ ${index}:`, ad);
                                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º
                          }

                         const li = document.createElement('li');
                         li.dataset.adId = ad.id;

                         const adDiv = document.createElement('div');
                         adDiv.style.flexGrow = '1';
                         adDiv.style.marginRight = '10px'; // –û—Ç—Å—Ç—É–ø –æ—Ç –∫–Ω–æ–ø–∫–∏

                         const textSpan = document.createElement('span');
                         textSpan.textContent = ad.text_preview;
                         if (ad.has_media) {
                              textSpan.textContent += " üñºÔ∏è"; // –ò–∫–æ–Ω–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞
                         }
                         adDiv.appendChild(textSpan);

                         li.appendChild(adDiv);

                         // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                         const viewBtn = document.createElement('button');
                         viewBtn.textContent = 'üëÅÔ∏è'; // –ò–∫–æ–Ω–∫–∞
                         viewBtn.title = '–°–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                         viewBtn.addEventListener('click', (event) => {
                            event.stopPropagation();
                            console.log(`[Action] –ö–ª–∏–∫ –°–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ ${ad.id}`);
                            viewAd(ad.id);
                         });
                         li.appendChild(viewBtn);

                         // –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                         li.addEventListener('click', (event) => {
                             if (event.target === li || event.target === adDiv || event.target === textSpan) {
                                 console.log(`[Action] –ö–ª–∏–∫ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ${ad.id}`);
                                 viewAd(ad.id);
                             }
                         });

                         adsListEl.appendChild(li);
                     });
                     console.log('[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.');
                     // TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏, –µ—Å–ª–∏ adsResponse.total_pages > 1
                 } catch (renderError) {
                     console.error('[Render] –û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–∏ renderAds:', renderError);
                     showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π. ${renderError.message}`);
                 }
            }


            // --- –§—É–Ω–∫—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API ---

            async function fetchCategories(parentId = null) {
                console.log(`[API] –ó–∞–ø—Ä–æ—Å –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è parentId: ${parentId}`);
                showLoading();
                let url = `${apiBaseUrl}/api/categories`;
                if (parentId !== null) {
                    url += `?parent_id=${parentId}`;
                }
                try {
                    const response = await fetch(url);
                    console.log(`[API] –û—Ç–≤–µ—Ç –æ—Ç ${url}: –°—Ç–∞—Ç—É—Å ${response.status}`);
                    if (!response.ok) {
                        let errorText = response.statusText;
                        try { errorText = await response.text(); } catch (e) {}
                        console.error(`[API] HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}, –¢–µ–∫—Å—Ç: ${errorText}`);
                        throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                    }

                    const responseClone = response.clone(); // –ö–ª–æ–Ω–∏—Ä—É–µ–º –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ JSON

                    try {
                        const categories = await response.json();
                        console.log('[API] –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã:', categories);
                        hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
                        renderCategories(categories);
                    } catch (jsonError) {
                         console.error('[API] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', jsonError);
                         const responseText = await responseClone.text();
                         console.error('[API] –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞, –≤—ã–∑–≤–∞–≤—à–µ–µ –æ—à–∏–±–∫—É JSON:', responseText);
                         throw new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ JSON?). ${jsonError.message}`);
                    }

                } catch (error) {
                    console.error('[API] –ü–æ–π–º–∞–Ω–∞ –æ—à–∏–±–∫–∞ –≤ fetchCategories:', error);
                    showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. ${error.message}`);
                    // –ù–µ –æ—á–∏—â–∞–µ–º –∑–¥–µ—Å—å, showError —É–∂–µ –æ—á–∏—â–∞–µ—Ç
                }
            }

            async function fetchAds(categoryId, page = 1, limit = 20) {
                 console.log(`[API] –ó–∞–ø—Ä–æ—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è categoryId: ${categoryId}, page: ${page}, limit: ${limit}`);
                 // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
                 adsListEl.innerHTML = '';
                 showLoading(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                 const url = `${apiBaseUrl}/api/categories/${categoryId}/ads?page=${page}&limit=${limit}`;
                 try {
                     const response = await fetch(url);
                     console.log(`[API] –û—Ç–≤–µ—Ç –æ—Ç ${url}: –°—Ç–∞—Ç—É—Å ${response.status}`);

                     // –ö–ª–æ–Ω –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏
                     const responseClone = response.clone();

                     if (!response.ok) {
                         // –ï—Å–ª–∏ 404 (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞), API –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É —Å –¥–µ—Ç–∞–ª—è–º–∏
                         let errorJson = null;
                         let errorText = response.statusText;
                         try { errorJson = await response.json(); errorText = errorJson.detail || errorText; } catch (e) {}
                         console.error(`[API] HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}, –î–µ—Ç–∞–ª–∏: ${errorText}`);
                         // –ò—Å–ø–æ–ª—å–∑—É–µ–º detail –∏–∑ JSON –æ—Ç–≤–µ—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                         throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                     }


                     try {
                         const adsResponse = await response.json();
                         console.log('[API] –û–±—ä—è–≤–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã:', adsResponse);
                         hideLoading();
                         renderAds(adsResponse);
                     } catch (jsonError) {
                          console.error('[API] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ–±—ä—è–≤–ª–µ–Ω–∏–π:', jsonError);
                          const responseText = await responseClone.text();
                          console.error('[API] –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞, –≤—ã–∑–≤–∞–≤—à–µ–µ –æ—à–∏–±–∫—É JSON:', responseText);
                          throw new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–µ JSON?). ${jsonError.message}`);
                     }

                 } catch (error) {
                     console.error(`[API] –ü–æ–π–º–∞–Ω–∞ –æ—à–∏–±–∫–∞ –≤ fetchAds –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categoryId}:`, error);
                     showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è. ${error.message}`);
                 }
            }

            // --- –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π ---

            function updateBackButton() {
                if (categoryHistory.length > 0) {
                    backButton.style.display = 'inline-block';
                } else {
                    backButton.style.display = 'none';
                }
                 console.log('[UI] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥, –≤–∏–¥–∏–º–æ—Å—Ç—å:', backButton.style.display);
            }

            function updatePathDisplay() {
                 let pathText = "–ö–∞—Ç–∞–ª–æ–≥";
                 if (categoryHistory.length > 0) {
                     pathText = categoryHistory.map(item => item.name).join(" / ");
                 }
                 currentPathEl.textContent = pathText;
                 console.log(`[UI] –û–±–Ω–æ–≤–ª–µ–Ω –ø—É—Ç—å: ${pathText}`);
            }

            function navigateToCategory(categoryId, categoryName) {
                 console.log(`[Nav] –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: ${categoryId} (${categoryName})`);
                 // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                 categoryHistory.push({ id: categoryId, name: categoryName });
                 updatePathDisplay();
                 updateBackButton();
                 // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ò –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                 fetchCategories(categoryId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                 fetchAds(categoryId);      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è (1-—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)
            }

            function showAds(categoryId, categoryName) {
                 console.log(`[Nav] –ü–æ–∫–∞–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${categoryId} (${categoryName})`);
                 // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Ç–∞–º
                 const lastHistoryItem = categoryHistory.length > 0 ? categoryHistory[categoryHistory.length - 1] : null;
                 if (!lastHistoryItem || lastHistoryItem.id !== categoryId) {
                      categoryHistory.push({ id: categoryId, name: categoryName });
                      console.log('[Nav] –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é:', { id: categoryId, name: categoryName });
                 }

                 updatePathDisplay();
                 updateBackButton();
                 categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç.–∫. –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –≤–µ—Ç–∫–∏
                 adsListEl.innerHTML = '';      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                 fetchAds(categoryId);          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            }


            function goBack() {
                console.log('[Nav] –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥');
                if (categoryHistory.length === 0) {
                     console.log('[Nav] –ù–µ–∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è.');
                     return;
                }

                categoryHistory.pop(); // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                console.log('[Nav] –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ pop:', categoryHistory);

                updatePathDisplay();
                updateBackButton();

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Ä–æ–¥–∏—Ç–µ–ª—è (–∏–ª–∏ null –¥–ª—è –∫–æ—Ä–Ω—è)
                const parentCategory = categoryHistory.length > 0 ? categoryHistory[categoryHistory.length - 1] : null;
                const parentId = parentCategory ? parentCategory.id : null;
                console.log(`[Nav] –í–æ–∑–≤—Ä–∞—Ç –∫ parentId: ${parentId}`);

                fetchCategories(parentId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è (–∏–ª–∏ –∫–æ—Ä–Ω–µ–≤—ã–µ)

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ—Ä–µ–Ω—å
                if (parentId !== null) {
                     fetchAds(parentId);
                } else {
                     adsListEl.innerHTML = ''; // –í –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
                }
            }

            function subscribeToCategory(categoryId) {
                 console.log(`[Send] –ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${categoryId}`);
                 const dataToSend = {
                     action: "subscribe",
                     category_id: categoryId
                 };
                 const jsonData = JSON.stringify(dataToSend);
                 console.log(`[Send] –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É: ${jsonData}`);
                 tg.sendData(jsonData);
                 // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
                 tg.HapticFeedback.notificationOccurred('success');
                 // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                 // alert(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${categoryId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!`);
            }

            function viewAd(adId) {
                 console.log(`[Send] –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ${adId}`);
                 const dataToSend = {
                     action: "show_ad",
                     ad_id: adId
                 };
                 const jsonData = JSON.stringify(dataToSend);
                 console.log(`[Send] –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É: ${jsonData}`);
                 tg.sendData(jsonData);
                 // –ó–∞–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–æ –Ω–µ –±—É–¥–µ–º, –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç –∏–ª–∏ –±–æ—Ç –µ–≥–æ –ø–µ—Ä–µ–∫—Ä–æ–µ—Ç
                 // tg.close();
            }

            // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
            console.log('[INIT] Telegram Web App —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è.');
            tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
            console.log('[INIT] Telegram.WebApp.ready() –≤—ã–∑–≤–∞–Ω.');
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Å—Ç—Ä–æ–π–∫—É —Ü–≤–µ—Ç–æ–≤ —Ç–µ–º—ã
             tg.setHeaderColor('secondary_bg_color'); // –ü—Ä–∏–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–≤–µ—Ç–∞ —Ö–µ–¥–µ—Ä–∞
             // tg.setBackgroundColor(...); // –ú–æ–∂–Ω–æ –∏ —Ñ–æ–Ω

            tg.expand(); // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º WebApp –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            console.log('[INIT] Telegram.WebApp.expand() –≤—ã–∑–≤–∞–Ω.');

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ –ù–∞–∑–∞–¥
            backButton.addEventListener('click', goBack);
            console.log('[INIT] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥ –¥–æ–±–∞–≤–ª–µ–Ω.');

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            console.log('[INIT] –ó–∞–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (parentId=null)...');
            fetchCategories(null);

        } catch(globalError) {
            // –õ–æ–≤–∏–º –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥–æ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏
            console.error("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Web App:", globalError);
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const errorDiv = document.getElementById('error-message') || document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.textContent = `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${globalError.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Web App.`;
            errorDiv.style.display = 'block';
            errorDiv.style.color = 'red';
            errorDiv.style.padding = '20px';
            errorDiv.style.textAlign = 'center';
             // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—â–µ –Ω–µ –≤ DOM, –¥–æ–±–∞–≤–ª—è–µ–º
             if (!document.getElementById('error-message')) {
                 document.body.prepend(errorDiv); // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ body
             }
             // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞
             const loadingDiv = document.getElementById('loading');
             if(loadingDiv) loadingDiv.style.display = 'none';
        }

    </script>

</body>
</html>
