<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог Объявлений (Тест JS Render String)</title>
    <!-- Подключаем скрипт Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили */
        body {
            font-family: sans-serif;
            padding: 10px;
            color: var(--tg-theme-text-color);
            background-color: var(--tg-theme-bg-color);
            margin: 0; /* Уберем отступы по умолчанию у body */
        }
        #categories-list, #ads-list {
            list-style: none; padding: 0; margin: 10px 0;
        }
        /* Стили для li применяются через инлайн-стили в JS для этого теста */
        /* #categories-list li, #ads-list li { ... } */

        .category-name { flex-grow: 1; margin-right: 10px; }
        button { display: none; } /* Скроем кнопки */
        .nav-arrow { display: none; } /* Скроем стрелки */
        #back-button { display: none; margin-bottom: 10px; padding: 8px 12px; }
        #loading { text-align: center; padding: 20px; color: var(--tg-theme-hint-color); display: none; }
        #error-message { text-align: center; padding: 20px; color: var(--tg-theme-destructive-text-color, red); font-weight: bold; display: none; }
        .empty-list-message { padding: 15px 5px; text-align: center; color: gray; }

         /* Добавим стиль для li через CSS, но JS будет использовать инлайн */
         #categories-list li, #ads-list li {
            /* Базовые стили, которые могут быть переопределены инлайном */
             border-bottom: 1px solid black;
             min-height: 30px;
             margin: 5px 0;
             padding: 8px 5px; /* Добавим падинг */
             display: block; /* Уберем flex для теста с innerHTML */
             cursor: pointer;
             /* Временные цвета для проверки */
             color: black !important;
             background-color: lightyellow !important;
         }
    </style>
</head>
<body>

    <h2 id="current-path">Каталог (Тест JS Render String)</h2>
    <button id="back-button">⬅️ Назад</button>
    <div id="loading">Загрузка...</div>
    <div id="error-message"></div>

    <ul id="categories-list">
        <!-- Сюда JS будет добавлять HTML строку -->
    </ul>
    <hr style="border: none; border-top: 1px solid black; margin: 10px 0;">
    <ul id="ads-list"></ul>

    <script>
        try {
            const tg = window.Telegram.WebApp;
            if (!tg) throw new Error("Telegram.WebApp not found");

            // УБЕДИТЕСЬ, что используете ПРАВИЛЬНЫЙ URL для вашего API
            // Либо http://127.0.0.1:8000 (если тестируете в Telegram Desktop/Web на ТОМ ЖЕ компьютере)
            // Либо HTTPS URL от ngrok (https://....ngrok-free.app) (если тестируете с телефона ИЛИ если http://127.0.0.1 не работает в Desktop)
            const apiBaseUrl = "http://127.0.0.1:8000"; // <<<--- ПРОВЕРЬТЕ ЭТОТ URL! (Или ngrok URL)
            console.log(`[INIT] API Base URL: ${apiBaseUrl}`);

            const categoriesListEl = document.getElementById('categories-list');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-message');
            const adsListEl = document.getElementById('ads-list'); // Нужен для showError

            if (!categoriesListEl || !loadingEl || !errorEl || !adsListEl) throw new Error("Missing required DOM elements");

            // Упрощенные функции UI
            function showLoading() {
                console.log('[UI] Show Loading');
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
            }
            function hideLoading() {
                 console.log('[UI] Hide Loading');
                 loadingEl.style.display = 'none';
            }
            function showError(message) {
                 console.error(`[UI] Show Error: ${message}`); // Логируем как ошибку
                 hideLoading();
                 // Показываем ошибку прямо в списке категорий для простоты
                 categoriesListEl.innerHTML = `<li class="empty-list-message" style="color: red !important; background: white !important;">Ошибка: ${message}</li>`;
                 adsListEl.innerHTML = ''; // Очищаем список объявлений
            }

            // --- НОВАЯ УПРОЩЕННАЯ ФУНКЦИЯ РЕНДЕРИНГА ---
            function renderCategories(categories) {
                console.log('[Render] Начало renderCategories (версия с innerHTML):', categories);
                try {
                    if (!categoriesListEl) {
                        console.error('[Render] ОШИБКА: categoriesListEl не найден!');
                        return;
                    }
                    // Очищаем перед добавлением
                    categoriesListEl.innerHTML = '';
                    if (!categories || categories.length === 0) {
                         console.log('[Render] Нет категорий для отображения.');
                         categoriesListEl.innerHTML = '<li class="empty-list-message">Категорий нет.</li>';
                         return;
                    }

                    let htmlString = ''; // Собираем HTML в строку
                    categories.forEach((cat, index) => {
                        console.log(`[Render] Формирование HTML для категории ${index}: ${cat.name}`);
                        if (typeof cat !== 'object' || cat === null || typeof cat.id === 'undefined' || typeof cat.name === 'undefined') {
                             console.warn(`[Render] Пропуск некорректного объекта категории ${index}:`, cat); // Warn вместо Error
                             return; // Пропускаем
                        }
                        // Добавляем li со стилями прямо в строку
                        // Обратите внимание на кавычки и экранирование, если имя категории содержит кавычки (пока не обрабатываем)
                        htmlString += `<li data-category-id="${cat.id}" style="color: black !important; background-color: lightyellow !important; border-bottom: 1px solid black; min-height: 30px; margin: 5px 0; padding: 8px 5px;">${cat.name} (JS String)</li>`;
                    });

                    console.log('[Render] Сформированная HTML строка:', htmlString);
                    // Вставляем весь HTML разом
                    categoriesListEl.innerHTML = htmlString;
                    console.log('[Render] HTML строка вставлена в categoriesListEl.');

                    // // --- Блок добавления обработчиков (ПОКА НЕ НУЖЕН) ---
                    // // После вставки через innerHTML нужно заново навешивать обработчики!
                    // // Это одна из причин, почему innerHTML менее предпочтителен для сложных структур.
                    // const categoryItems = categoriesListEl.querySelectorAll('li[data-category-id]');
                    // console.log(`[Render] Найдено ${categoryItems.length} элементов li для добавления обработчиков`);
                    // categoryItems.forEach(liElement => {
                    //     const catId = parseInt(liElement.dataset.categoryId, 10);
                    //     // Находим соответствующую категорию в исходных данных, чтобы получить имя и has_children
                    //     const categoryData = categories.find(c => c.id === catId);
                    //     if (categoryData) {
                    //          console.log(`[Render] Добавление обработчика для li с ID ${catId}`);
                    //         // TODO: Добавить обработчики клика здесь, если нужно будет
                    //         // liElement.addEventListener('click', () => { /*...*/ });
                    //     } else {
                    //          console.warn(`[Render] Не найдены данные для категории с ID ${catId} при добавлении обработчика`);
                    //     }
                    // });
                    // console.log('[Render] Добавление обработчиков завершено (если были).');


                } catch (renderError) {
                     console.error('[Render] Ошибка внутри renderCategories (версия с innerHTML):', renderError);
                     showError(`Ошибка отображения категорий. ${renderError.message}`);
                }
            }
            // --- КОНЕЦ НОВОЙ УПРОЩЕННОЙ ФУНКЦИИ ---

            // --- Функция запроса fetchCategories (без изменений) ---
             async function fetchCategories(parentId = null) {
                console.log(`[API] Запрос категорий для parentId: ${parentId}`);
                showLoading();
                let url = `${apiBaseUrl}/api/categories`;
                if (parentId !== null) {
                    url += `?parent_id=${parentId}`;
                }
                try {
                    const response = await fetch(url);
                    console.log(`[API] Ответ от ${url}: Статус ${response.status}`);
                    if (!response.ok) {
                        let errorText = response.statusText;
                        try { errorText = await response.text(); } catch (e) {}
                        console.error(`[API] HTTP ошибка! Статус: ${response.status}, Текст: ${errorText}`);
                        throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                    }
                    const responseClone = response.clone();
                    try {
                        const categories = await response.json();
                        console.log('[API] Категории успешно распарсены:', categories);
                        hideLoading();
                        renderCategories(categories); // Вызываем УПРОЩЕННЫЙ рендер
                    } catch (jsonError) {
                         console.error('[API] Ошибка парсинга JSON категорий:', jsonError);
                         const responseText = await responseClone.text();
                         console.error('[API] Тело ответа, вызвавшее ошибку JSON:', responseText);
                         throw new Error(`Ошибка обработки ответа сервера (не JSON?). ${jsonError.message}`);
                    }
                } catch (error) {
                    console.error('[API] Поймана ошибка в fetchCategories:', error);
                    showError(`Не удалось загрузить категории. ${error.message}`);
                }
            }

            // --- Остальные функции (объявления, навигация) пока не нужны ---

            // --- Инициализация ---
            console.log('[INIT] Telegram Web App скрипт выполняется.');
            tg.ready();
            console.log('[INIT] Telegram.WebApp.ready() вызван.');
            tg.expand();
            console.log('[INIT] Telegram.WebApp.expand() вызван.');
            console.log('[INIT] Запуск начальной загрузки категорий (parentId=null)...');
            fetchCategories(null); // Запускаем загрузку

        } catch(globalError) {
            console.error("Глобальная ошибка инициализации Web App:", globalError);
            const errorDiv = document.getElementById('error-message') || document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.textContent = `Критическая ошибка при инициализации: ${globalError.message}. Попробуйте перезапустить Web App.`;
            errorDiv.style.display = 'block';
            errorDiv.style.color = 'red';
            // ... остальной код отображения глобальной ошибки ...
        }
    </script>

</body>
</html>
