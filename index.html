<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –û–±—ä—è–≤–ª–µ–Ω–∏–π</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ —Å —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Ü–≤–µ—Ç–æ–≤ */
        body { font-family: sans-serif; padding: 10px; margin: 0; color: #1c1c1c; background-color: #ffffff; }
        #categories-list, #ads-list { list-style: none; padding: 0; margin: 10px 0; }
        #categories-list li, #ads-list li { padding: 8px 5px; border-bottom: 1px solid var(--tg-theme-hint-color, #dddddd); cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 30px; }
        #categories-list li:hover { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        .category-name { flex-grow: 1; margin-right: 10px; }
        .nav-arrow { color: var(--tg-theme-hint-color, #888888); font-weight: bold; margin-left: 5px; }
        .ad-preview { font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; }
        button { padding: 5px 8px; margin-left: 5px; background-color: var(--tg-theme-button-color, #2481cc); color: var(--tg-theme-button-text-color, #ffffff); border: none; border-radius: 4px; cursor: pointer; flex-shrink: 0; }
        #back-button { margin-bottom: 10px; padding: 8px 12px; background-color: var(--tg-theme-button-color, #2481cc); color: var(--tg-theme-button-text-color, #ffffff); border: none; border-radius: 4px; }
        #loading { text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #888888); display: none; }
        #error-message { text-align: center; padding: 20px; color: var(--tg-theme-destructive-text-color, red); font-weight: bold; display: none; }
        .empty-list-message { padding: 15px 5px; text-align: center; color: var(--tg-theme-hint-color, #888888); cursor: default; border-bottom: none; display: block; min-height: auto; }
        hr { border: none; border-top: 1px solid var(--tg-theme-hint-color, #dddddd); margin: 15px 0; }
        h2 { margin-top: 0; color: var(--tg-theme-text-color, #1c1c1c); }
         /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
         #pagination { text-align: center; padding: 15px 0; }
         #pagination button { margin: 0 5px; padding: 6px 10px; }
         #pagination button:disabled { background-color: lightgray; cursor: default; opacity: 0.6; } /* –°—Ç–∏–ª—å –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
         #pagination span { margin: 0 10px; font-weight: bold; }
         /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–æ–≥–æ–≤ */
         #log-output { margin-top: 20px; border: 1px solid #ccc; padding: 5px; height: 150px; overflow-y: scroll; font-size: 0.8em; white-space: pre-wrap; background-color: #f8f8f8; color: #333; }
         #log-output div { margin-bottom: 3px; padding-bottom: 3px; border-bottom: 1px dotted #eee; } /* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ */
         #log-output div:last-child { border-bottom: none; }

    </style>
</head>
<body>

    <h2 id="current-path">–ö–∞—Ç–∞–ª–æ–≥</h2>
    <button id="back-button" style="display: none;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error-message"></div>

    <ul id="categories-list"></ul>
    <hr>
    <ul id="ads-list"></ul>
    <div id="pagination"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->
    <div id="log-output">–õ–æ–≥–∏:</div> <!-- –ë–ª–æ–∫ –¥–ª—è –ª–æ–≥–æ–≤ -->


    <script>
        // --- –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---
        const logOutputEl = document.getElementById('log-output');
        function log(message) {
            console.log(message); // –í –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
            if (logOutputEl) {
                try {
                    const now = new Date();
                    const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}.${String(now.getMilliseconds()).padStart(3,'0')}`;
                    const logLine = document.createElement('div');
                    logLine.textContent = `[${timeStr}] ${message}`;
                    logOutputEl.appendChild(logLine);
                    logOutputEl.scrollTop = logOutputEl.scrollHeight;
                } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:", e); }
            } else { console.warn("logOutputEl –Ω–µ –Ω–∞–π–¥–µ–Ω:", message); }
        }
        // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è ---

        // --- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω');

                const tg = window.Telegram.WebApp;
                if (!tg) throw new Error("Telegram.WebApp –Ω–µ –Ω–∞–π–¥–µ–Ω");
                log('–û–±—ä–µ–∫—Ç tg –Ω–∞–π–¥–µ–Ω');

                // --- –í–°–¢–ê–í–õ–ï–ù –í–ê–® NGROK URL ---
                const apiBaseUrl = "https://a8d1-159-65-48-29.ngrok-free.app";
                log(`API URL: ${apiBaseUrl}`);

                const categoriesListEl = document.getElementById('categories-list');
                const adsListEl = document.getElementById('ads-list');
                const currentPathEl = document.getElementById('current-path');
                const backButton = document.getElementById('back-button');
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error-message');
                const paginationEl = document.getElementById('pagination');

                if (!categoriesListEl || !adsListEl || !currentPathEl || !backButton || !loadingEl || !errorEl || !paginationEl) {
                     log("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ –≤—Å–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã!");
                    throw new Error("Missing required DOM elements");
                }
                log("DOM —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã.");

                let categoryHistory = [];
                let currentPage = 1;
                let currentCategoryId = null;

                // --- –§—É–Ω–∫—Ü–∏–∏ ---
                function showLoading() { log('[UI] Show Loading'); loadingEl.style.display = 'block'; errorEl.style.display = 'none'; }
                function hideLoading() { log('[UI] Hide Loading'); loadingEl.style.display = 'none'; }
                function showError(message) {
                    log(`[UI] –û–®–ò–ë–ö–ê: ${message}`); hideLoading();
                    if (errorEl) { errorEl.textContent = `–û—à–∏–±–∫–∞: ${message}`; errorEl.style.display = 'block';}
                    if (categoriesListEl) categoriesListEl.innerHTML = ''; if (adsListEl) adsListEl.innerHTML = ''; if (paginationEl) paginationEl.innerHTML = '';
                }

                function renderCategories(categories) {
                    log(`[Render] renderCategories (${categories?.length ?? 0} —à—Ç.)`);
                    try {
                        categoriesListEl.innerHTML = '';
                        if (!categories || categories.length === 0) {
                             const li=document.createElement('li'); li.className='empty-list-message'; li.textContent = categoryHistory.length>0?'–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç.':'–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.'; categoriesListEl.appendChild(li); return;
                        }
                        categories.forEach(cat => {
                             if (typeof cat !== 'object' || cat === null || typeof cat.id === 'undefined' || typeof cat.name === 'undefined') return;
                             const li = document.createElement('li'); li.dataset.categoryId = cat.id;
                             const nameSpan = document.createElement('span'); nameSpan.className = 'category-name'; nameSpan.textContent = cat.name; li.appendChild(nameSpan);
                             const btns = document.createElement('div'); btns.style.display='flex'; btns.style.alignItems='center';
                             const btnSub = document.createElement('button'); btnSub.textContent='üîî'; btnSub.title=`–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${cat.name}`; btnSub.addEventListener('click',(e)=>{ e.stopPropagation(); subscribeToCategory(cat.id); }); btns.appendChild(btnSub);
                             if (cat.has_children) {
                                 const arrow = document.createElement('span'); arrow.className='nav-arrow'; arrow.textContent='>'; btns.appendChild(arrow);
                                 li.addEventListener('click',(e)=>{ if(e.target!==btnSub) navigateToCategory(cat.id,cat.name); });
                             } else { li.addEventListener('click',(e)=>{ if(e.target!==btnSub) showAds(cat.id,cat.name); }); }
                             li.appendChild(btns); categoriesListEl.appendChild(li);
                        }); log('[Render] –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã.');
                    } catch (renderError) { log(`–û–®–ò–ë–ö–ê –≤ renderCategories: ${renderError.message}`); showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${renderError.message}`); }
                }
                function renderAds(adsResponse) {
                    log(`[Render] renderAds (items: ${adsResponse?.items?.length ?? 0})`);
                    try {
                        adsListEl.innerHTML = '';
                        if (!adsResponse || !adsResponse.items || adsResponse.items.length === 0) {
                             const li=document.createElement('li'); li.className='empty-list-message'; li.textContent = '–û–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ—Ç.'; adsListEl.appendChild(li); renderPagination(adsResponse); return;
                        }
                        adsResponse.items.forEach(ad => {
                             if (typeof ad !== 'object' || ad === null || typeof ad.id === 'undefined' || typeof ad.text_preview === 'undefined') return;
                             const li = document.createElement('li'); li.dataset.adId = ad.id;
                             const adDiv = document.createElement('div'); adDiv.className='ad-preview'; adDiv.textContent=ad.text_preview; if(ad.has_media) adDiv.textContent+=" üñºÔ∏è"; li.appendChild(adDiv);
                             const btnView = document.createElement('button'); btnView.textContent='üëÅÔ∏è'; btnView.title='–°–º–æ—Ç—Ä–µ—Ç—å'; btnView.addEventListener('click',(e)=>{ e.stopPropagation(); viewAd(ad.id); }); li.appendChild(btnView);
                             li.addEventListener('click',(e)=>{ if(e.target !== btnView) viewAd(ad.id); }); adsListEl.appendChild(li);
                        }); log('[Render] –û–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã.'); renderPagination(adsResponse);
                    } catch (renderError) { log(`–û–®–ò–ë–ö–ê –≤ renderAds: ${renderError.message}`); showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π: ${renderError.message}`); }
                }
                 function renderPagination(adsResponse) {
                     paginationEl.innerHTML = ''; log(`[Pagination] Render: page=${adsResponse?.page}, total=${adsResponse?.total_pages}`);
                     if (!adsResponse || adsResponse.total_pages <= 1) return;
                     const current = adsResponse.page; const total = adsResponse.total_pages;
                     const btnPrev = document.createElement('button'); btnPrev.textContent='‚¨ÖÔ∏è –ü—Ä–µ–¥.'; btnPrev.disabled = current <= 1;
                     btnPrev.addEventListener('click', () => { if (current > 1 && currentCategoryId !== null) fetchAds(currentCategoryId, current - 1); }); paginationEl.appendChild(btnPrev);
                     const info = document.createElement('span'); info.textContent = `${current} / ${total}`; paginationEl.appendChild(info);
                     const btnNext = document.createElement('button'); btnNext.textContent='–°–ª–µ–¥. ‚û°Ô∏è'; btnNext.disabled = current >= total;
                     btnNext.addEventListener('click', () => { if (current < total && currentCategoryId !== null) fetchAds(currentCategoryId, current + 1); }); paginationEl.appendChild(btnNext);
                     log('[Pagination] –ü–∞–≥–∏–Ω–∞—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–∞.');
                 }

                // --- API ---
                async function fetchCategories(parentId = null) {
                    log(`[API] fetchCategories parent: ${parentId}`); showLoading(); let url = `${apiBaseUrl}/api/categories`; if (parentId !== null) url += `?parent_id=${parentId}`;
                    try { const r = await fetch(url); log(`[API] Categories status: ${r.status}`); if (!r.ok) throw new Error(`HTTP ${r.status}`); const d = await r.json(); hideLoading(); renderCategories(d);
                    } catch (e) { log(`[API] fetchCategories –û–®–ò–ë–ö–ê: ${e.message}`); showError(`–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${e.message}`); }
                }
                async function fetchAds(categoryId, page = 1, limit = 20) {
                     log(`[API] fetchAds cat: ${categoryId}, page: ${page}`); currentCategoryId=categoryId; currentPage=page; adsListEl.innerHTML=''; paginationEl.innerHTML=''; showLoading(); let url = `${apiBaseUrl}/api/categories/${categoryId}/ads?page=${page}&limit=${limit}`;
                     try { const r = await fetch(url); log(`[API] Ads status: ${r.status}`); if (!r.ok) { let txt=r.statusText; try{const j=await r.json();txt=j.detail||txt;}catch(e){} throw new Error(`HTTP ${r.status}: ${txt}`); } const d = await r.json(); hideLoading(); renderAds(d);
                     } catch (e) { log(`[API] fetchAds –û–®–ò–ë–ö–ê: ${e.message}`); showError(`–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π: ${e.message}`); }
                }

                // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è ---
                 function updateBackButton() { backButton.style.display = categoryHistory.length > 0 ? 'inline-block' : 'none'; }
                 function updatePathDisplay() { currentPathEl.textContent = categoryHistory.length === 0 ? "–ö–∞—Ç–∞–ª–æ–≥" : "–ö–∞—Ç–∞–ª–æ–≥ / " + categoryHistory.map(item => item.name).join(" / "); }
                 function navigateToCategory(id, name) { log(`[Nav] > ${id}`); categoryHistory.push({id,name}); updatePathDisplay(); updateBackButton(); fetchCategories(id); fetchAds(id, 1); }
                 function showAds(id, name) { log(`[Nav] Ads ${id}`); const last=categoryHistory.length>0?categoryHistory[categoryHistory.length-1]:null; if(!last||last.id!==id) categoryHistory.push({id,name}); updatePathDisplay(); updateBackButton(); categoriesListEl.innerHTML='<li class="empty-list-message">–û–±—ä—è–≤–ª–µ–Ω–∏—è:</li>'; adsListEl.innerHTML=''; paginationEl.innerHTML=''; fetchAds(id, 1); }
                 function goBack() { log('[Nav] Back'); if (categoryHistory.length === 0) return; categoryHistory.pop(); updatePathDisplay(); updateBackButton(); const parent=categoryHistory.length>0?categoryHistory[categoryHistory.length-1]:null; const parentId=parent?parent.id:null; log(`[Nav] Back to: ${parentId}`); fetchCategories(parentId); if(parentId !== null) fetchAds(parentId, 1); else { adsListEl.innerHTML=''; paginationEl.innerHTML=''; currentCategoryId=null;} }
                 function subscribeToCategory(id) { log(`[Send] Subscribe: ${id}`); tg.sendData(JSON.stringify({action:"subscribe",category_id:id})); tg.HapticFeedback.notificationOccurred('success'); }
                 function viewAd(id) { log(`[Send] View Ad: ${id}`); tg.sendData(JSON.stringify({action:"show_ad",ad_id:id})); }

                // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
                log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App...');
                tg.ready(); log('tg.ready() –≤—ã–∑–≤–∞–Ω');
                tg.expand(); log('tg.expand() –≤—ã–∑–≤–∞–Ω');
                backButton.addEventListener('click', goBack); log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ù–∞–∑–∞–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
                log('–ó–∞–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
                fetchCategories(null);

            } catch(globalError) {
                 // –ò—Å–ø–æ–ª—å–∑—É–µ–º log –¥–ª—è –≤—ã–≤–æ–¥–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏
                 log(`–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê: ${globalError.message}`);
                 // alert(`–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –û–®–ò–ë–ö–ê: ${globalError.message}`);
                 const errorDiv = document.getElementById('error-message'); if(errorDiv) { errorDiv.textContent = `–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${globalError.message}.`; errorDiv.style.display='block'; }
                 const loadingDiv = document.getElementById('loading'); if(loadingDiv) loadingDiv.style.display='none';
                 const catList = document.getElementById('categories-list'); if(catList) catList.innerHTML='';
                 console.error("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:", globalError); // –î—É–±–ª–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
            }
        });
    </script>
</body>
</html>
