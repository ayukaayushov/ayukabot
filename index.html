<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог Объявлений (Тест JS Render)</title>
    <!-- Подключаем скрипт Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили оставляем с временными цветами для li */
        body {
            font-family: sans-serif;
            padding: 10px;
            color: var(--tg-theme-text-color);
            background-color: var(--tg-theme-bg-color);
        }
        #categories-list, #ads-list {
            list-style: none; padding: 0; margin: 10px 0;
        }
        #categories-list li, #ads-list li {
            padding: 8px 5px;
            border-bottom: 1px solid black; /* Явная граница */
            cursor: pointer;
            display: flex; /* Оставим flex для базового выравнивания */
            justify-content: space-between;
            align-items: center;
            min-height: 30px;
            color: black !important; /* Тестовый цвет текста */
            background-color: lightyellow !important; /* Тестовый цвет фона */
            margin: 5px 0;
        }
        .category-name { flex-grow: 1; margin-right: 10px; }
        /* Остальные стили (кнопки, стрелки и т.д.) пока не важны */
        button { display: none; } /* Скроем кнопки на время теста */
        .nav-arrow { display: none; } /* Скроем стрелки */
        #back-button, #loading, #error-message { display: none; }
        .empty-list-message { padding: 15px 5px; text-align: center; color: gray; }
    </style>
</head>
<body>

    <h2 id="current-path">Каталог (Тест JS Render)</h2>
    <button id="back-button">⬅️ Назад</button> <!-- Оставляем, но скрыт стилями -->
    <div id="loading">Загрузка...</div>
    <div id="error-message"></div>

    <ul id="categories-list">
        <!-- Сюда JS будет добавлять элементы -->
    </ul>
    <hr style="border: none; border-top: 1px solid black; margin: 10px 0;">
    <ul id="ads-list"></ul>

    <!-- Раскомментируем скрипт -->
    <script>
        try {
            const tg = window.Telegram.WebApp;
            if (!tg) throw new Error("Telegram.WebApp not found");

            const apiBaseUrl = "http://127.0.0.1:8000"; // Убедитесь, что API запущен здесь ИЛИ используйте URL ngrok
            console.log(`[INIT] API Base URL: ${apiBaseUrl}`);

            const categoriesListEl = document.getElementById('categories-list');
            // Другие элементы пока не используем активно
            // const adsListEl = document.getElementById('ads-list');
            // const currentPathEl = document.getElementById('current-path');
            // const backButton = document.getElementById('back-button');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error-message');

            if (!categoriesListEl || !loadingEl || !errorEl) throw new Error("Missing required DOM elements");

            // --- Упрощенные функции ---

            function showLoading() {
                console.log('[UI] Показ загрузки');
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
            }

            function hideLoading() {
                 console.log('[UI] Скрытие загрузки');
                 loadingEl.style.display = 'none';
            }

            function showError(message) {
                 // Пока не показываем ошибку пользователю
                 console.error(`[UI] ОШИБКА: ${message}`);
                 hideLoading();
                 categoriesListEl.innerHTML = `<li class="empty-list-message">Ошибка загрузки: ${message}</li>`; // Выводим ошибку в список
                 // adsListEl.innerHTML = '';
            }

            // --- УПРОЩЕННАЯ ФУНКЦИЯ РЕНДЕРИНГА ---
            function renderCategories(categories) {
                console.log('[Render] Начало УПРОЩЕННОГО renderCategories с данными:', categories);
                try {
                    if (!categoriesListEl) {
                        console.error('[Render] ОШИБКА: categoriesListEl не найден!');
                        return;
                    }
                    categoriesListEl.innerHTML = ''; // Очищаем
                    if (!categories || categories.length === 0) {
                         console.log('[Render] Нет категорий для отображения.');
                         categoriesListEl.innerHTML = '<li class="empty-list-message">Категорий нет.</li>';
                         return;
                    }

                    categories.forEach((cat, index) => {
                        console.log(`[Render] Обработка категории ${index}:`, cat);
                        if (typeof cat !== 'object' || cat === null || typeof cat.id === 'undefined' || typeof cat.name === 'undefined') {
                             console.error(`[Render] Пропуск некорректного объекта категории ${index}:`, cat);
                             return;
                        }

                        // 1. Создаем li
                        const li = document.createElement('li');
                        console.log(`[Render]   ${index}: Создан li`);

                        // 2. Создаем span
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'category-name';
                        nameSpan.textContent = cat.name + " (JS)"; // Добавим маркер, что это из JS
                        console.log(`[Render]   ${index}: Создан span с текстом: ${nameSpan.textContent}`);

                        // 3. Добавляем span в li
                        li.appendChild(nameSpan);
                        console.log(`[Render]   ${index}: Span добавлен в li`);

                        // 4. Добавляем li в основной список ul
                        categoriesListEl.appendChild(li);
                        console.log(`[Render]   ${index}: Li добавлен в categoriesListEl`);
                    });
                    console.log('[Render] УПРОЩЕННЫЙ Рендеринг категорий завершен.');
                } catch (renderError) {
                     console.error('[Render] Ошибка внутри УПРОЩЕННОГО renderCategories:', renderError);
                     showError(`Ошибка отображения категорий. ${renderError.message}`);
                }
            }
            // --- КОНЕЦ УПРОЩЕННОЙ ФУНКЦИИ РЕНДЕРИНГА ---

            // --- Функция запроса (оставляем как была, с отладкой) ---
             async function fetchCategories(parentId = null) {
                console.log(`[API] Запрос категорий для parentId: ${parentId}`);
                showLoading();
                let url = `${apiBaseUrl}/api/categories`;
                if (parentId !== null) {
                    url += `?parent_id=${parentId}`;
                }
                try {
                    const response = await fetch(url);
                    console.log(`[API] Ответ от ${url}: Статус ${response.status}`);
                    if (!response.ok) {
                        let errorText = response.statusText;
                        try { errorText = await response.text(); } catch (e) {}
                        console.error(`[API] HTTP ошибка! Статус: ${response.status}, Текст: ${errorText}`);
                        throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                    }
                    const responseClone = response.clone();
                    try {
                        const categories = await response.json();
                        console.log('[API] Категории успешно распарсены:', categories);
                        hideLoading();
                        renderCategories(categories); // Вызываем УПРОЩЕННЫЙ рендер
                    } catch (jsonError) {
                         console.error('[API] Ошибка парсинга JSON категорий:', jsonError);
                         const responseText = await responseClone.text();
                         console.error('[API] Тело ответа, вызвавшее ошибку JSON:', responseText);
                         throw new Error(`Ошибка обработки ответа сервера (не JSON?). ${jsonError.message}`);
                    }
                } catch (error) {
                    console.error('[API] Поймана ошибка в fetchCategories:', error);
                    showError(`Не удалось загрузить категории. ${error.message}`);
                }
            }

            // --- Остальные функции (навигация, ads и т.д.) пока не нужны ---
            // function renderAds(...) {}
            // async function fetchAds(...) {}
            // function updateBackButton() {}
            // function updatePathDisplay() {}
            // function navigateToCategory(...) {}
            // function showAds(...) {}
            // function goBack() {}
            // function subscribeToCategory(...) {}
            // function viewAd(...) {}

            // --- Инициализация ---
            console.log('[INIT] Telegram Web App скрипт выполняется.');
            tg.ready();
            console.log('[INIT] Telegram.WebApp.ready() вызван.');
            tg.expand();
            console.log('[INIT] Telegram.WebApp.expand() вызван.');
            // backButton.addEventListener('click', goBack); // Кнопка "Назад" пока не нужна
            console.log('[INIT] Запуск начальной загрузки категорий (parentId=null)...');
            fetchCategories(null); // Запускаем загрузку

        } catch(globalError) {
            console.error("Глобальная ошибка инициализации Web App:", globalError);
            const errorDiv = document.getElementById('error-message') || document.createElement('div');
            // ... код отображения глобальной ошибки ...
        }
    </script>

</body>
</html>
