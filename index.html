<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Каталог (Тест Синхронного Рендера)</title>
    <!-- Подключаем скрипт Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили оставляем с временными цветами для li */
        body {
            font-family: sans-serif;
            padding: 10px;
            color: var(--tg-theme-text-color);
            background-color: var(--tg-theme-bg-color);
            margin: 0;
        }
        #categories-list, #ads-list {
            list-style: none; padding: 0; margin: 10px 0;
        }
        #categories-list li, #ads-list li {
            padding: 8px 5px;
            border-bottom: 1px solid black;
            cursor: pointer;
            display: block; /* Упрощенный display */
            min-height: 30px;
            color: black !important; /* Тестовый цвет текста */
            background-color: lightyellow !important; /* Тестовый цвет фона */
            margin: 5px 0;
        }
        .category-name { /* Этот класс не используется в упрощенном рендере */ }
        button { display: none; }
        .nav-arrow { display: none; }
        #back-button, #loading, #error-message { display: none; }
        .empty-list-message { padding: 15px 5px; text-align: center; color: gray; }
        #log-output { margin-top: 10px; border: 1px solid #ccc; padding: 5px; height: 200px; overflow-y: scroll; font-size: 0.8em; white-space: pre-wrap; }
    </style>
</head>
<body>

    <h2 id="current-path">Каталог (Тест Синхронного Рендера)</h2>
    <button id="back-button">⬅️ Назад</button>
    <div id="loading">Загрузка...</div>
    <div id="error-message"></div>

    <ul id="categories-list">
        <!-- Сюда JS будет добавлять элементы СИНХРОННО -->
    </ul>
    <div id="log-output">Логи:</div>

    <!-- <hr> -->
    <!-- <ul id="ads-list"></ul> -->

    <script>
        const logOutput = document.getElementById('log-output');
        function log(message) {
            console.log(message);
            if (logOutput) {
                const now = new Date();
                const timeString = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}.${now.getMilliseconds()}`;
                logOutput.textContent += `\n[${timeString}] ${message}`;
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        }

        try {
            log('Скрипт запущен');
            const tg = window.Telegram.WebApp;
            if (!tg) throw new Error("Telegram.WebApp не найден");
            log('Объект tg найден');

            // API URL пока не используется
            // const apiBaseUrl = "http://127.0.0.1:8000"; // Или ngrok
            // log(`API URL: ${apiBaseUrl}`);

            const categoriesListEl = document.getElementById('categories-list');
            if (!categoriesListEl) throw new Error("Элемент #categories-list не найден");
            log('Элемент #categories-list найден');

            // --- Упрощенная функция рендеринга (такая же, как в прошлый раз) ---
            function renderCategories(categories) {
                log(`Начало renderCategories. Получено категорий: ${categories?.length ?? 0}`);
                try {
                    categoriesListEl.innerHTML = ''; // Очистка
                    if (!categories || categories.length === 0) {
                        log('Нет категорий для рендеринга.');
                        categoriesListEl.innerHTML = '<li>Категорий нет.</li>';
                        return;
                    }
                    let count = 0;
                    categories.forEach((cat, index) => {
                        if (typeof cat === 'object' && cat !== null && cat.name) {
                            log(`Рендеринг категории ${index}: ${cat.name}`);
                            const li = document.createElement('li');
                            li.textContent = cat.name + ' (JS Sync)'; // Добавим другой маркер
                            categoriesListEl.appendChild(li);
                            log(`  -- Элемент для "${cat.name}" добавлен в DOM.`);
                            count++;
                        } else {
                            log(`Пропуск некорректного элемента категории на индексе ${index}`);
                        }
                    });
                    log(`Рендеринг завершен. Добавлено элементов: ${count}`);
                } catch (renderError) {
                    log(`ОШИБКА в renderCategories: ${renderError.message}`);
                    showError(`Ошибка отображения категорий: ${renderError.message}`);
                }
            }

            function showError(message) { // Функция showError нужна для renderCategories
                 log(`ОШИБКА: ${message}`);
                 categoriesListEl.innerHTML = `<li style="color: red !important; background: white !important;">Ошибка: ${message}</li>`;
            }

            // --- Инициализация Telegram ---
            log('Инициализация Telegram Web App...');
            tg.ready();
            log('tg.ready() вызван.');
            tg.expand();
            log('tg.expand() вызван.');

            // --- ТЕСТОВЫЙ СИНХРОННЫЙ ВЫЗОВ РЕНДЕРИНГА ---
            log('Вызов renderCategories с тестовыми данными СИНХРОННО...');
            const testData = [
                { id: 101, name: 'Тест Синхронный 1' },
                { id: 102, name: 'Тест Синхронный 2' },
                { id: 103, name: 'Тест Синхронный 3' }
            ];
            try {
                renderCategories(testData); // Вызываем рендер с тестовыми данными
                log('Синхронный renderCategories завершен УСПЕШНО.');
            } catch (e) {
                log(`!!! ОШИБКА при синхронном вызове renderCategories: ${e.message}`);
                showError(`Ошибка синхронного рендеринга: ${e.message}`);
            }
            // --- КОНЕЦ ТЕСТОВОГО ВЫЗОВА ---

            // --- Запрос к API пока ЗАКОММЕНТИРОВАН ---
            // async function fetchCategories() { ... }
            // log('Запуск fetchCategories...');
            // fetchCategories(null);

        } catch(globalError) {
            log(`ГЛОБАЛЬНАЯ ОШИБКА: ${globalError.message}`);
            alert(`ГЛОБАЛЬНАЯ ОШИБКА: ${globalError.message}`);
            document.body.innerHTML = `<div style="color: red; padding: 20px;">Глобальная ошибка: ${globalError.message}</div>`;
        }
    </script>
</body>
</html>
