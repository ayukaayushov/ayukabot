<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –û–±—ä—è–≤–ª–µ–Ω–∏–π</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ —Å —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã —Ü–≤–µ—Ç–æ–≤ */
        body { font-family: sans-serif; padding: 10px; margin: 0; color: #1c1c1c; background-color: #ffffff; }
        #categories-list, #ads-list { list-style: none; padding: 0; margin: 10px 0; }
        #categories-list li, #ads-list li { padding: 8px 5px; border-bottom: 1px solid var(--tg-theme-hint-color, #dddddd); cursor: pointer; display: flex; justify-content: space-between; align-items: center; min-height: 30px; }
        #categories-list li:hover { background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        .category-name { flex-grow: 1; margin-right: 10px; }
        .nav-arrow { color: var(--tg-theme-hint-color, #888888); font-weight: bold; margin-left: 5px; }
        .ad-preview { font-size: 0.95em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; }
        button { padding: 5px 8px; margin-left: 5px; background-color: var(--tg-theme-button-color, #2481cc); color: var(--tg-theme-button-text-color, #ffffff); border: none; border-radius: 4px; cursor: pointer; flex-shrink: 0; }
        #back-button { margin-bottom: 10px; padding: 8px 12px; background-color: var(--tg-theme-button-color, #2481cc); color: var(--tg-theme-button-text-color, #ffffff); border: none; border-radius: 4px; }
        #loading { text-align: center; padding: 20px; color: var(--tg-theme-hint-color, #888888); display: none; }
        #error-message { text-align: center; padding: 20px; color: var(--tg-theme-destructive-text-color, red); font-weight: bold; display: none; }
        .empty-list-message { padding: 15px 5px; text-align: center; color: var(--tg-theme-hint-color, #888888); cursor: default; border-bottom: none; display: block; min-height: auto; }
        hr { border: none; border-top: 1px solid var(--tg-theme-hint-color, #dddddd); margin: 15px 0; }
        h2 { margin-top: 0; color: var(--tg-theme-text-color, #1c1c1c); }
         /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ */
         #pagination { text-align: center; padding: 15px 0; }
         #pagination button { margin: 0 5px; padding: 6px 10px; }
         #pagination button:disabled { background-color: lightgray; cursor: default; }
         #pagination span { margin: 0 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2 id="current-path">–ö–∞—Ç–∞–ª–æ–≥</h2>
    <button id="back-button" style="display: none;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error-message"></div>

    <ul id="categories-list"></ul>
    <hr>
    <ul id="ads-list"></ul>
    <div id="pagination"></div> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ -->


    <script>
        // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const tg = window.Telegram.WebApp;
                if (!tg) throw new Error("Telegram.WebApp not found");

                // --- –ò–°–ü–û–õ–¨–ó–£–ï–ú –í–ê–® NGROK URL ---
                const apiBaseUrl = "https://a8d1-159-65-48-29.ngrok-free.app";
                console.log(`[INIT] API Base URL: ${apiBaseUrl}`);

                const categoriesListEl = document.getElementById('categories-list');
                const adsListEl = document.getElementById('ads-list');
                const currentPathEl = document.getElementById('current-path');
                const backButton = document.getElementById('back-button');
                const loadingEl = document.getElementById('loading');
                const errorEl = document.getElementById('error-message');
                const paginationEl = document.getElementById('pagination'); // –ù–∞—Ö–æ–¥–∏–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é

                if (!categoriesListEl || !adsListEl || !currentPathEl || !backButton || !loadingEl || !errorEl || !paginationEl) {
                    throw new Error("Missing required DOM elements");
                }

                let categoryHistory = [];
                let currentPage = 1; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                let currentCategoryId = null; // –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

                // --- –§—É–Ω–∫—Ü–∏–∏ ---
                function showLoading() { /*...*/ console.log('[UI] Show Loading'); loadingEl.style.display = 'block'; errorEl.style.display = 'none'; }
                function hideLoading() { /*...*/ console.log('[UI] Hide Loading'); loadingEl.style.display = 'none'; }
                function showError(message) { /*...*/ console.error(`[UI] –û–®–ò–ë–ö–ê: ${message}`); hideLoading(); errorEl.textContent = `–û—à–∏–±–∫–∞: ${message}`; errorEl.style.display = 'block'; categoriesListEl.innerHTML = ''; adsListEl.innerHTML = ''; paginationEl.innerHTML = ''; }

                function renderCategories(categories) {
                    console.log('[Render] renderCategories:', categories);
                    try {
                        categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º
                        if (!categories || categories.length === 0) {
                             const li = document.createElement('li'); li.className = 'empty-list-message';
                             li.textContent = categoryHistory.length > 0 ? '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç.' : '–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.';
                             categoriesListEl.appendChild(li); return;
                        }
                        categories.forEach(cat => { /* ... (–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º "—Ñ–∏–Ω–∞–ª—å–Ω–æ–º" –≤–∞—Ä–∏–∞–Ω—Ç–µ) ... */
                             if (typeof cat !== 'object' || cat === null || typeof cat.id === 'undefined' || typeof cat.name === 'undefined') return;
                             const li = document.createElement('li'); li.dataset.categoryId = cat.id;
                             const nameSpan = document.createElement('span'); nameSpan.className = 'category-name'; nameSpan.textContent = cat.name; li.appendChild(nameSpan);
                             const buttonsDiv = document.createElement('div'); buttonsDiv.style.display = 'flex'; buttonsDiv.style.alignItems = 'center';
                             const subscribeBtn = document.createElement('button'); subscribeBtn.textContent = 'üîî'; subscribeBtn.title = `–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${cat.name}`;
                             subscribeBtn.addEventListener('click', (e) => { e.stopPropagation(); subscribeToCategory(cat.id); });
                             buttonsDiv.appendChild(subscribeBtn);
                             if (cat.has_children) {
                                 const arrowSpan = document.createElement('span'); arrowSpan.className = 'nav-arrow'; arrowSpan.textContent = '>'; buttonsDiv.appendChild(arrowSpan);
                                 li.addEventListener('click', (e) => { if (e.target !== subscribeBtn) navigateToCategory(cat.id, cat.name); });
                             } else {
                                 li.addEventListener('click', (e) => { if (e.target !== subscribeBtn) showAds(cat.id, cat.name); });
                             }
                             li.appendChild(buttonsDiv); categoriesListEl.appendChild(li);
                        });
                        console.log('[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.');
                    } catch (renderError) { console.error('[Render] –û—à–∏–±–∫–∞ –≤ renderCategories:', renderError); showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π: ${renderError.message}`); }
                }

                function renderAds(adsResponse) {
                    console.log('[Render] renderAds:', adsResponse);
                    try {
                        adsListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º
                        if (!adsResponse || !adsResponse.items || adsResponse.items.length === 0) {
                             const li = document.createElement('li'); li.className = 'empty-list-message';
                             li.textContent = '–û–±—ä—è–≤–ª–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç.'; adsListEl.appendChild(li);
                             renderPagination(adsResponse); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –¥–∞–∂–µ –µ—Å–ª–∏ –ø—É—Å—Ç–æ (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
                             return;
                        }
                        adsResponse.items.forEach(ad => { /* ... (–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º "—Ñ–∏–Ω–∞–ª—å–Ω–æ–º" –≤–∞—Ä–∏–∞–Ω—Ç–µ) ... */
                             if (typeof ad !== 'object' || ad === null || typeof ad.id === 'undefined' || typeof ad.text_preview === 'undefined') return;
                             const li = document.createElement('li'); li.dataset.adId = ad.id;
                             const adDiv = document.createElement('div'); adDiv.className = 'ad-preview'; adDiv.textContent = ad.text_preview;
                             if (ad.has_media) adDiv.textContent += " üñºÔ∏è"; li.appendChild(adDiv);
                             const viewBtn = document.createElement('button'); viewBtn.textContent = 'üëÅÔ∏è'; viewBtn.title = '–°–º–æ—Ç—Ä–µ—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                             viewBtn.addEventListener('click', (e) => { e.stopPropagation(); viewAd(ad.id); });
                             li.appendChild(viewBtn);
                             li.addEventListener('click', (e) => { if (e.target !== viewBtn) viewAd(ad.id); });
                             adsListEl.appendChild(li);
                        });
                        console.log('[Render] –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.');
                        renderPagination(adsResponse); // –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–Ω–¥–µ—Ä –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                    } catch (renderError) { console.error('[Render] –û—à–∏–±–∫–∞ –≤ renderAds:', renderError); showError(`–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π: ${renderError.message}`); }
                }

                 // --- –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ---
                 function renderPagination(adsResponse) {
                     paginationEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–∞–≥–∏–Ω–∞—Ü–∏—é
                     console.log(`[Pagination] Render: page=${adsResponse.page}, total_pages=${adsResponse.total_pages}`);
                     if (adsResponse.total_pages <= 1) {
                         return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é, –µ—Å–ª–∏ 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ –º–µ–Ω—å—à–µ
                     }

                     const currentPageNum = adsResponse.page;
                     const totalPagesNum = adsResponse.total_pages;

                     // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
                     const prevButton = document.createElement('button');
                     prevButton.textContent = '‚¨ÖÔ∏è –ü—Ä–µ–¥.';
                     prevButton.disabled = currentPageNum <= 1; // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                     prevButton.addEventListener('click', () => {
                         if (currentPageNum > 1 && currentCategoryId !== null) {
                             fetchAds(currentCategoryId, currentPageNum - 1);
                         }
                     });
                     paginationEl.appendChild(prevButton);

                     // –¢–µ–∫—Å—Ç "–°—Ç—Ä–∞–Ω–∏—Ü–∞ X –∏–∑ Y"
                     const pageInfo = document.createElement('span');
                     pageInfo.textContent = `${currentPageNum} / ${totalPagesNum}`;
                     paginationEl.appendChild(pageInfo);

                     // –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥"
                     const nextButton = document.createElement('button');
                     nextButton.textContent = '–°–ª–µ–¥. ‚û°Ô∏è';
                     nextButton.disabled = currentPageNum >= totalPagesNum; // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                     nextButton.addEventListener('click', () => {
                         if (currentPageNum < totalPagesNum && currentCategoryId !== null) {
                             fetchAds(currentCategoryId, currentPageNum + 1);
                         }
                     });
                     paginationEl.appendChild(nextButton);
                 }
                 // --- –ö–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ ---


                // --- –§—É–Ω–∫—Ü–∏–∏ API ---
                async function fetchCategories(parentId = null) {
                    console.log(`[API] fetchCategories parentId: ${parentId}`);
                    showLoading(); let url = `${apiBaseUrl}/api/categories`;
                    if (parentId !== null) url += `?parent_id=${parentId}`;
                    try {
                        const response = await fetch(url);
                        console.log(`[API] Categories response status: ${response.status}`);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const categories = await response.json(); hideLoading(); renderCategories(categories);
                    } catch (error) { console.error('[API] fetchCategories error:', error); showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${error.message}`); }
                }
                async function fetchAds(categoryId, page = 1, limit = 20) {
                     console.log(`[API] fetchAds categoryId: ${categoryId}, page: ${page}`);
                     // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
                     currentCategoryId = categoryId;
                     currentPage = page;
                     adsListEl.innerHTML = ''; paginationEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
                     showLoading(); let url = `${apiBaseUrl}/api/categories/${categoryId}/ads?page=${page}&limit=${limit}`;
                     try {
                         const response = await fetch(url);
                         console.log(`[API] Ads response status: ${response.status}`);
                         if (!response.ok) {
                             let errorText = response.statusText; let errorJson = null;
                             try { errorJson = await response.json(); errorText = errorJson.detail || errorText; } catch(e){}
                             throw new Error(`HTTP ${response.status}: ${errorText}`);
                         }
                         const adsResponse = await response.json(); hideLoading(); renderAds(adsResponse);
                     } catch (error) { console.error('[API] fetchAds error:', error); showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è: ${error.message}`); }
                }

                // --- –ù–∞–≤–∏–≥–∞—Ü–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è ---
                 function updateBackButton() { backButton.style.display = categoryHistory.length > 0 ? 'inline-block' : 'none'; }
                 function updatePathDisplay() { currentPathEl.textContent = categoryHistory.length === 0 ? "–ö–∞—Ç–∞–ª–æ–≥" : "–ö–∞—Ç–∞–ª–æ–≥ / " + categoryHistory.map(item => item.name).join(" / "); }
                 function navigateToCategory(categoryId, categoryName) { console.log(`[Nav] Navigate to: ${categoryId}`); categoryHistory.push({ id: categoryId, name: categoryName }); updatePathDisplay(); updateBackButton(); fetchCategories(categoryId); fetchAds(categoryId, 1); /* –í—Å–µ–≥–¥–∞ —Å 1–π —Å—Ç—Ä */ }
                 function showAds(categoryId, categoryName) { console.log(`[Nav] Show ads for: ${categoryId}`); const last = categoryHistory.length > 0 ? categoryHistory[categoryHistory.length - 1] : null; if (!last || last.id !== categoryId) categoryHistory.push({ id: categoryId, name: categoryName }); updatePathDisplay(); updateBackButton(); categoriesListEl.innerHTML = '<li class="empty-list-message">–û–±—ä—è–≤–ª–µ–Ω–∏—è:</li>'; adsListEl.innerHTML = ''; paginationEl.innerHTML = ''; fetchAds(categoryId, 1); /* –í—Å–µ–≥–¥–∞ —Å 1–π —Å—Ç—Ä */ }
                 function goBack() { console.log('[Nav] Go Back'); if (categoryHistory.length === 0) return; categoryHistory.pop(); updatePathDisplay(); updateBackButton(); const parent = categoryHistory.length > 0 ? categoryHistory[categoryHistory.length - 1] : null; const parentId = parent ? parent.id : null; fetchCategories(parentId); if (parentId !== null) fetchAds(parentId, 1); else { adsListEl.innerHTML = ''; paginationEl.innerHTML = ''; currentCategoryId = null; } }
                 function subscribeToCategory(categoryId) { console.log(`[Send] Subscribe: ${categoryId}`); tg.sendData(JSON.stringify({ action: "subscribe", category_id: categoryId })); tg.HapticFeedback.notificationOccurred('success'); }
                 function viewAd(adId) { console.log(`[Send] View Ad: ${adId}`); tg.sendData(JSON.stringify({ action: "show_ad", ad_id: adId })); }

                // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
                console.log('[INIT] DOMContentLoaded');
                log('[INIT] DOMContentLoaded, —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
                tg.ready(); log('tg.ready() –≤—ã–∑–≤–∞–Ω');
                tg.expand(); log('tg.expand() –≤—ã–∑–≤–∞–Ω');
                backButton.addEventListener('click', goBack); log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ù–∞–∑–∞–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
                log('–ó–∞–ø—É—Å–∫ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...');
                fetchCategories(null); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–Ω–µ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

            } catch(globalError) {
                console.error("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:", globalError);
                // –§—É–Ω–∫—Ü–∏—è log –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ –µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                alert(`–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${globalError.message}`);
                document.body.innerHTML = `<div style="color: red; padding: 20px;">–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: ${globalError.message}</div>`;
            }
        });
    </script>
</body>
</html>
