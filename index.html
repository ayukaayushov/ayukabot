<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–∞–ª–æ–≥ –û–±—ä—è–≤–ª–µ–Ω–∏–π</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–∫—Ä–∏–ø—Ç Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –ü—Ä–æ—Å—Ç—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏ */
        body {
            font-family: sans-serif;
            padding: 10px;
            color: var(--tg-theme-text-color); /* –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–∞ —Ç–µ–º—ã Telegram */
            background-color: var(--tg-theme-bg-color);
        }
        #categories-list, #ads-list {
            list-style: none;
            padding: 0;
        }
        #categories-list li, #ads-list li {
            padding: 8px 5px;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         #categories-list li:hover {
             background-color: var(--tg-theme-secondary-bg-color);
         }
        .category-name {
            flex-grow: 1;
            margin-right: 10px;
        }
        .nav-arrow { /* –°—Ç—Ä–µ–ª–æ—á–∫–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –¥–µ—Ç—å–º–∏ */
             color: var(--tg-theme-hint-color);
        }
        .ad-preview {
            font-size: 0.9em;
            color: var(--tg-theme-hint-color);
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        button {
            padding: 5px 8px;
            margin-left: 5px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #back-button {
            margin-bottom: 10px;
        }
        #loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color);
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
        }
         #error-message {
             text-align: center;
             padding: 20px;
             color: red; /* –û—à–∏–±–∫–∏ –∫—Ä–∞—Å–Ω—ã–º */
             display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
         }
    </style>
</head>
<body>

    <h2 id="current-path">–ö–∞—Ç–∞–ª–æ–≥</h2>
    <button id="back-button" style="display: none;">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>

    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error-message"></div>

    <ul id="categories-list">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    </ul>

    <ul id="ads-list">
        <!-- –°—é–¥–∞ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è -->
    </ul>

    <script>
        const tg = window.Telegram.WebApp;
        const apiBaseUrl = "http://127.0.0.1:8000"; // URL –≤–∞—à–µ–≥–æ API

        const categoriesListEl = document.getElementById('categories-list');
        const adsListEl = document.getElementById('ads-list');
        const currentPathEl = document.getElementById('current-path');
        const backButton = document.getElementById('back-button');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error-message');

        let categoryHistory = []; // –°—Ç–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏

        // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ---

        function showLoading() {
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
            categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–∫–∏
            adsListEl.innerHTML = '';
        }

        function hideLoading() {
            loadingEl.style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            errorEl.textContent = `–û—à–∏–±–∫–∞: ${message}`;
            errorEl.style.display = 'block';
        }

        function renderCategories(categories) {
            categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
            if (!categories || categories.length === 0) {
                 // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç", –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –∫–æ—Ä–Ω–µ
                 if (categoryHistory.length > 0) {
                      const li = document.createElement('li');
                      li.textContent = '–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç';
                      li.style.color = 'var(--tg-theme-hint-color)';
                      li.style.cursor = 'default';
                      categoriesListEl.appendChild(li);
                 }
                 return;
            }

            categories.forEach(cat => {
                const li = document.createElement('li');
                li.dataset.categoryId = cat.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

                const nameSpan = document.createElement('span');
                nameSpan.className = 'category-name';
                nameSpan.textContent = cat.name;
                li.appendChild(nameSpan);

                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É –∏ –¥–µ–ª–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                if (cat.has_children) {
                    const arrowSpan = document.createElement('span');
                    arrowSpan.className = 'nav-arrow';
                    arrowSpan.textContent = '>';
                    li.appendChild(arrowSpan);
                    li.addEventListener('click', () => navigateToCategory(cat.id, cat.name));
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∫–ª–∏–∫ —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                    li.addEventListener('click', () => showAds(cat.id, cat.name));
                }

                // –ö–Ω–æ–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                const subscribeBtn = document.createElement('button');
                subscribeBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                subscribeBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–ª–∏–∫ –ø–æ li –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
                    subscribeToCategory(cat.id);
                });
                li.appendChild(subscribeBtn);


                categoriesListEl.appendChild(li);
            });
        }

        function renderAds(adsResponse) {
             adsListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Ä–µ–Ω–¥–µ—Ä–æ–º
             if (!adsResponse || !adsResponse.items || adsResponse.items.length === 0) {
                 const li = document.createElement('li');
                 li.textContent = '–û–±—ä—è–≤–ª–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç.';
                 li.style.color = 'var(--tg-theme-hint-color)';
                 li.style.cursor = 'default';
                 adsListEl.appendChild(li);
                 return;
             }

             adsResponse.items.forEach(ad => {
                 const li = document.createElement('li');
                 li.dataset.adId = ad.id;

                 const adDiv = document.createElement('div');
                 adDiv.style.flexGrow = '1';

                 const textSpan = document.createElement('span');
                 textSpan.textContent = ad.text_preview;
                 if (ad.has_media) {
                      textSpan.textContent += " üñºÔ∏è"; // –ò–∫–æ–Ω–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ–¥–∏–∞
                 }
                 adDiv.appendChild(textSpan);

                 // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –¥–µ—Ç–∞–ª–µ–π, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                 // const detailSpan = document.createElement('div');
                 // detailSpan.className = 'ad-preview';
                 // detailSpan.textContent = `ID: ${ad.id}`;
                 // adDiv.appendChild(detailSpan);

                 li.appendChild(adDiv);

                 // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                 const viewBtn = document.createElement('button');
                 viewBtn.textContent = '–°–º–æ—Ç—Ä–µ—Ç—å';
                 viewBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    viewAd(ad.id);
                 });
                 li.appendChild(viewBtn);

                 // –ö–ª–∏–∫ –ø–æ –≤—Å–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É —Ç–æ–∂–µ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ
                 li.addEventListener('click', () => viewAd(ad.id));


                 adsListEl.appendChild(li);
             });

             // TODO: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏, –µ—Å–ª–∏ total_pages > 1
        }


        // --- –§—É–Ω–∫—Ü–∏–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API ---

        async function fetchCategories(parentId = null) {
            showLoading();
            let url = `${apiBaseUrl}/api/categories`;
            if (parentId !== null) {
                url += `?parent_id=${parentId}`;
            }
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const categories = await response.json();
                hideLoading();
                renderCategories(categories);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
                showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏. ${error.message}`);
            }
        }

        async function fetchAds(categoryId, page = 1, limit = 20) {
             // –ù–µ –æ—á–∏—â–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
             adsListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
             showLoading(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
             const url = `${apiBaseUrl}/api/categories/${categoryId}/ads?page=${page}&limit=${limit}`;
             try {
                 const response = await fetch(url);
                 if (!response.ok) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ 404 (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞) –æ—Ç–¥–µ–ª—å–Ω–æ –Ω–µ –Ω—É–∂–Ω–∞, —Ç.–∫. API –≤–µ—Ä–Ω–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –∏–ª–∏ –æ—à–∏–±–∫—É
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 const adsResponse = await response.json();
                 hideLoading();
                 renderAds(adsResponse);
             } catch (error) {
                 console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${categoryId}:`, error);
                 showError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è. ${error.message}`);
             }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π ---

        function updateBackButton() {
            if (categoryHistory.length > 0) {
                backButton.style.display = 'inline-block';
            } else {
                backButton.style.display = 'none';
            }
        }

        function updatePathDisplay() {
             if (categoryHistory.length === 0) {
                 currentPathEl.textContent = "–ö–∞—Ç–∞–ª–æ–≥";
             } else {
                 // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                 currentPathEl.textContent = categoryHistory.map(item => item.name).join(" / ");
             }
        }

        function navigateToCategory(categoryId, categoryName) {
             console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é: ${categoryId} (${categoryName})`);
             // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤ –∏—Å—Ç–æ—Ä–∏—é
             categoryHistory.push({ id: categoryId, name: categoryName });
             updatePathDisplay();
             updateBackButton();
             // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
             fetchCategories(categoryId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
             fetchAds(categoryId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        }

        function showAds(categoryId, categoryName) {
             // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
             console.log(`–ü–æ–∫–∞–∑ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${categoryId} (${categoryName})`);
             // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –±—ã–ª –ø—Ä—è–º–æ–π –∫–ª–∏–∫ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±–µ–∑ –¥–µ—Ç–µ–π –∏–∑ —Å–ø–∏—Å–∫–∞
             // –ü—Ä–æ–≤–µ—Ä–∏–º, –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
             const lastHistoryItem = categoryHistory[categoryHistory.length - 1];
             if (!lastHistoryItem || lastHistoryItem.id !== categoryId) {
                  categoryHistory.push({ id: categoryId, name: categoryName });
             }

             updatePathDisplay();
             updateBackButton();
             categoriesListEl.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
             fetchAds(categoryId); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
        }


        function goBack() {
            if (categoryHistory.length === 0) return; // –ù–µ–∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è

            categoryHistory.pop(); // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏

            updatePathDisplay();
            updateBackButton();

            const parentCategory = categoryHistory[categoryHistory.length - 1];
            const parentId = parentCategory ? parentCategory.id : null;

            fetchCategories(parentId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–æ–¥–∏—Ç–µ–ª—è
            if (parentId !== null) {
                 fetchAds(parentId); // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è
            } else {
                 adsListEl.innerHTML = ''; // –í –∫–æ—Ä–Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ—Ç
            }
        }

        function subscribeToCategory(categoryId) {
             console.log(`–ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ${categoryId}`);
             const dataToSend = {
                 action: "subscribe",
                 category_id: categoryId
             };
             tg.sendData(JSON.stringify(dataToSend));
             // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ñ–∏–¥–±–µ–∫ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞
             tg.HapticFeedback.notificationOccurred('success'); // –í–∏–±—Ä–æ–æ—Ç–∫–ª–∏–∫
        }

        function viewAd(adId) {
             console.log(`–ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ${adId}`);
             const dataToSend = {
                 action: "show_ad",
                 ad_id: adId
             };
             tg.sendData(JSON.stringify(dataToSend));
             // –û–±—ã—á–Ω–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp
             // tg.close();
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        tg.ready(); // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
        tg.expand(); // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º WebApp –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω

        backButton.addEventListener('click', goBack);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        fetchCategories(null);

    </script>

</body>
</html>
